<html>
  <head>
    <title>Protobuffer rpc protocol specification v0.1</title>
  </head>
  <body>
<h1>Protobuffer rpc protocol specification v0.1:</h1>
<h3>References in this specification</h3>
<ul><li><b>Protocol buffers:</b> <a href="http://code.google.com/p/protobuf/">Google protocol buffers</a>. Protocol buffers that are used to make the messages, and as a support library for the rpc implementation.
</li></ul>
<h3>Terms used in this specification</h3>
<ul>
  <li>In wire format descriptions:
  <ul>
    <li><b>description(n), where n is a number:</b> an unsigned integer with length n bytes encoded in little endian format.</li>
    <li><b>description(n), where n is a letter:</b> a byte string with length n.</li>
</ul></li>
</ul>
<h2>Format codes</h2>
<table border="1">
  <tr><td>INIT</td><td>1</td></tr>
  <tr><td>REQUEST</td><td>2</td></tr>
  <tr><td>RESPONSE</td><td>3</td></tr>
  <tr><td>RESPONSE_CANCEL</td><td>6</td></tr>
  <tr><td>RESPONSE_NOT_IMPLEMENTED</td><td>7</td></tr>
  <tr><td>DISCONNECT</td><td>8</td></tr>
  <tr><td>UNKNOWN</td><td>255</td></tr>
</table>

<h3>Messages</h3>
<h4>INIT message</h4>
<p>INIT messages are sent by the first part that wants to send something (A) on the line.  If one part sends something else before the INIT code on the line the other part should shut down the connection.</p>
The conversation goes as this:
<table border="1">
<tr><th>A</th><th>B</th></tr>
<tr><td>Send:INIT(1),requested version(1)</td><td>Read</td></tr>
<tr><td>Send</td><td>Send:INIT(1),used version(1)</td></tr>
</table>
Where:
<ul>
 <li>INIT is the code for initalization</li>
 <li>
 requested version is the version with the highest number A supports and used version is the version with the highest number B supports, but not higher than the number of the requested version. All communication after this is done with the used version.
 </li>
</ul>
<h4>REQUEST message</h4>
<p>The REQUEST message is sent when a part wants to call a method on the other part.The other part should respond by a RESPONSE, or a RESPONSE_CANCEL when the method is finished</p>
<p>The message is sent like this: REQUEST(1),message number(2),method index(2),request message length(2),request message(n).</p>
Where:
<ul>
 <li>REQUEST is the code for requests</li>
 <li>Message number is an unique index that starts with 0 and goes upwards trough the session, and wraps if it should be larger than 2^16. The message number should be used when making a RESPONSe or RESPONSE_CANCEL message. </li>
 <li>The method index is the result of MethodDescriptor.getIndex(), on the protocol buffer metod descriptor that should be sent.</li>
 <li>Request message length, is the length of the followin request message in bytes,n.</li>
 <li>Request message is the request message, encoded as a protocol buffer Message which can be built from the Service.getRequestPrototype(method) message type</li>
</ul>
<h4>RESPONSE message</h4>
<p>The RESPONSE message is sent when a part has recieved a REQUEST message, and the method that was called by the request ran the response callback.</p>
<p>The message is sent like this: RESPONSE(1),message number(2),response message length(2),response message(n).</p>
Where:
<ul>
 <li>RESPONSE is the code for requests</li>
 <li>Message number used in this message should be the same as the message number in the REQUEST that called the method.</li>
 <li>Response message length, is the length of the followin response message in bytes,n.</li>
 <li>Response message is the response message, encoded as a protocol buffer Message which can be built from the Service.getResponsePrototype(method) message type</li>
</ul>
<h4>RESPONSE_CANCEL message</h4>
<p>The RESPONSE_CANCEL message is sent when a part has recieved a REQUEST message, and the method that was called by the request requested that it should be canceled in the RpcController.</p>
<p>The message is sent like this: RESPONSE_CANCEL(1),message number(2)</p>
Where:
<ul>
 <li>RESPONSE_CANCEL is the code for requests</li>
 <li>Message number used in this message should be the same as the message number in the REQUEST that called the method.</li>
</ul>
<h4>RESPONSE_NOT_IMPLEMENTED message</h4>
<p>The RESPONSE_NOT_IMPLEMENTED message is sent when a part has recieved a REQUEST message, and the method that was called by the request had an index higher than the number of methods imlemented by the underlying service. This most likely signalises that the peer has an older protobuffer than caller.</p>
<p>The message is sent like this: RESPONSE_NOT_IMPLEMENTED(1),message number(2)</p>
Where:
<ul>
 <li>RESPONSE_NOT_IMPLEMENTED is the code for requests</li>
 <li>Message number used in this message should be the same as the message number in the REQUEST that called the method.</li>
</ul>

<h4>DISCONNECT message</h4>
<p>The DISCONNECT message is sent before a part disconnects if it hasn't recieved a DISCONNECT message. The other part should try to disconnect the connnection.</p>
<p>The message is sent like this: DISCONNECT(1)</p>
Where:
<ul>
 <li>DISCONNECT is the code for disconnects</li>
</ul>
<hr>
<a rel="license" href="http://creativecommons.org/licenses/by-nd/3.0/no/">
<img alt="Creative Commons License" style="border-width:0" src="88x31.png" />
</a>
<br />This 
<span xmlns:dc="http://purl.org/dc/elements/1.1/" href="http://purl.org/dc/dcmitype/Text" rel="dc:type">work</span> is licensed under a 
<a rel="license" href="http://creativecommons.org/licenses/by-nd/3.0/no/">Creative Commons Attribution-No Derivative Works 3.0 Norway License</a>.
<br/>
This license does not apply to implementations of this protocol. The protocol may be implemented freely.
</body>
</html>
